{% extends 'base.html' %}
{% load static %}

{% block title %}{{ lesson.title }} - Education Ecosystem{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard_beautiful.css' %}">
{% endblock %}

{% block content %}
<div class="row dashboard-header">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
            <div>
                <h1><i class="bi bi-book-fill"></i> {{ lesson.title }}</h1>
                <p class="text-muted mb-0">
                    <i class="bi bi-folder-fill"></i> {{ lesson.course.course_code }} - {{ lesson.course.title }}
                </p>
            </div>
            <span class="badge badge-content-type" style="font-size: 1rem; padding: 0.75rem 1.5rem;">
                {% if lesson.content_type == 'video' %}
                <i class="bi bi-play-circle-fill"></i> Video Lesson
                {% elif lesson.content_type == 'audio' %}
                <i class="bi bi-music-note-beamed"></i> Audio Lesson
                {% else %}
                <i class="bi bi-file-text-fill"></i> Text Lesson
                {% endif %}
            </span>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="section-card">
            <!-- Lesson Meta Info -->
            <div class="d-flex flex-wrap gap-4 mb-4 pb-4 border-bottom">
                <div>
                    <i class="bi bi-person-fill text-primary"></i>
                    <strong>Teacher:</strong> {{ lesson.course.teacher.get_full_name|default:lesson.course.teacher.username }}
                </div>
                <div>
                    <i class="bi bi-calendar-event text-primary"></i>
                    <strong>Created:</strong> {{ lesson.created_at|date:"M d, Y" }}
                </div>
            </div>
            
            <!-- Description -->
            <div class="mb-4">
                <h4 class="mb-3"><i class="bi bi-file-text text-primary"></i> Description</h4>
                <p>{{ lesson.description }}</p>
            </div>
            
            <!-- Video Content -->
            {% if lesson.content_type == 'video' %}
            <div class="mb-4">
                <h4 class="mb-3"><i class="bi bi-play-btn text-primary"></i> Video Lesson</h4>
                
                {% if youtube_id %}
                <div class="ratio ratio-16x9 mb-3" style="border-radius: 24px; overflow: hidden; box-shadow: 0 8px 16px rgba(0,0,0,0.1);">
                    <iframe src="https://www.youtube-nocookie.com/embed/{{ youtube_id }}?rel=0&modestbranding=1" 
                            frameborder="0"
                            allowfullscreen
                            referrerpolicy="strict-origin-when-cross-origin"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"></iframe>
                </div>
                <a href="https://www.youtube.com/watch?v={{ youtube_id }}" target="_blank" class="btn btn-outline-primary">
                    <i class="bi bi-box-arrow-up-right"></i> Watch on YouTube
                </a>
                {% else %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> No video content available for this lesson.
                </div>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- Audio Content -->
            {% if lesson.content_type == 'audio' and lesson.file %}
            <div class="mb-4">
                <h4 class="mb-3"><i class="bi bi-music-note-beamed text-primary"></i> Audio Lesson</h4>
                <div class="p-4" style="background: #f8f9fa; border-radius: 24px;">
                    <audio controls class="w-100">
                        <source src="{{ lesson.file.url }}" type="audio/mpeg">
                        Your browser does not support the audio element.
                    </audio>
                </div>
            </div>
            {% endif %}
            
            <!-- Image Content -->
            {% if lesson.content_type == 'image' and lesson.file %}
            <div class="mb-4">
                <h4 class="mb-3"><i class="bi bi-image text-primary"></i> Image Content</h4>
                <div style="border-radius: 24px; overflow: hidden; box-shadow: 0 8px 16px rgba(0,0,0,0.1);">
                    <img src="{{ lesson.file.url }}" alt="{{ lesson.title }}" class="img-fluid">
                </div>
            </div>
            {% endif %}
            
            <!-- Text Content -->
            {% if lesson.text_content %}
            <div class="mb-4">
                <h4 class="mb-3"><i class="bi bi-file-text text-primary"></i> Lesson Content</h4>
                <div class="p-4" style="background: #f8f9fa; border-radius: 24px; line-height: 1.8;">
                    {{ lesson.text_content|linebreaks }}
                </div>
                
                <!-- Text-to-Speech Button -->
                <button onclick="readContent()" class="btn btn-primary mt-3">
                    <i class="bi bi-volume-up"></i> Read Aloud
                </button>
                <button onclick="window.speechSynthesis.cancel()" class="btn btn-outline-secondary mt-3 ms-2">
                    <i class="bi bi-stop-circle"></i> Stop
                </button>
            </div>
            {% endif %}
            
            <!-- Transcript -->
            {% if lesson.transcript %}
            <div class="mb-4">
                <h4 class="mb-3"><i class="bi bi-chat-left-text text-primary"></i> Transcript</h4>
                <div class="p-4" style="background: #e8e0ff; border-radius: 24px; border-left: 6px solid #b19cd9;">
                    {{ lesson.transcript|linebreaks }}
                </div>
            </div>
            {% endif %}
            
            <!-- File Download -->
            {% if lesson.file and lesson.content_type not in 'audio,image' %}
            <div class="mb-4">
                <h4 class="mb-3"><i class="bi bi-file-earmark-arrow-down text-primary"></i> Additional Materials</h4>
                <a href="{{ lesson.file.url }}" download class="btn btn-success">
                    <i class="bi bi-download"></i> Download File
                </a>
            </div>
            {% endif %}
            
            <!-- Sign Language Video -->
            {% if lesson.sign_language_video_url %}
            <div class="mb-4">
                <h4 class="mb-3"><i class="bi bi-hand-index text-primary"></i> Sign Language Version</h4>
                <div class="ratio ratio-16x9" style="border-radius: 24px; overflow: hidden; box-shadow: 0 8px 16px rgba(0,0,0,0.1);">
                    <iframe src="{{ lesson.sign_language_video_url }}" 
                            frameborder="0"
                            allowfullscreen></iframe>
                </div>
            </div>
            {% endif %}
            
            <!-- Navigation Buttons -->
            <div class="mt-5 d-flex gap-3 flex-wrap">
                <a href="{% url 'course_detail' lesson.course.id %}" class="btn btn-primary">
                    <i class="bi bi-arrow-left"></i> Back to Course
                </a>
                
                {% if user == lesson.course.teacher %}
                <a href="{% url 'lesson_edit' lesson.id %}" class="btn btn-warning">
                    <i class="bi bi-pencil-fill"></i> Edit Lesson
                </a>
                {% endif %}
                
                {% if user.profile.role == 'student' %}
                <a href="{% url 'assignment_list' %}" class="btn btn-success">
                    <i class="bi bi-list-check"></i> View Assignments
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
function readContent() {
    const content = `{{ lesson.text_content|escapejs }}`;
    if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(content);
        utterance.rate = 0.9;
        utterance.pitch = 1;
        window.speechSynthesis.speak(utterance);
    } else {
        alert('Text-to-speech is not supported in your browser.');
    }
}
</script>
{% endblock %}
