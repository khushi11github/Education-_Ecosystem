{% extends 'base.html' %}

{% block title %}Mark Attendance - Education Ecosystem{% endblock %}

{% block content %}
<style>
    :root {
        --cream: #fefdfa;
        --lavender: #b19cd9;
        --lavender-light: #d4c5f9;
        --lavender-lighter: #e8e0ff;
        --mint: #a7e9af;
        --mint-light: #d4f4dd;
        --peach: #ffb3a7;
        --pale-yellow: #fff4b8;
        --text-dark: #3e3e4a;
        --text-muted: #8a8a9e;
        --shadow-light: -6px -6px 14px rgba(255,255,255,0.9);
        --shadow-dark: 6px 6px 14px rgba(174,174,192,0.4);
    }
    
    body {
        background: var(--cream);
        font-family: 'Nunito', sans-serif;
    }
    
    .mark-attendance-header {
        background: linear-gradient(135deg, var(--mint) 0%, var(--mint-light) 100%);
        color: white;
        padding: 2.5rem 2rem;
        border-radius: 40px;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-light), var(--shadow-dark);
        position: relative;
        overflow: hidden;
    }
    
    .mark-attendance-header::before {
        content: '';
        position: absolute;
        top: -40%;
        right: -10%;
        width: 300px;
        height: 300px;
        background: rgba(255,255,255,0.2);
        border-radius: 50%;
        animation: float 7s ease-in-out infinite;
    }
    
    @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-25px); }
    }
    
    .mark-attendance-header h1 {
        margin: 0 0 0.5rem 0;
        font-weight: 800;
        font-size: 2.25rem;
        position: relative;
        z-index: 1;
    }
    
    .mark-attendance-header p {
        margin: 0;
        font-size: 1.05rem;
        position: relative;
        z-index: 1;
    }
    
    .student-row {
        background: var(--cream);
        border-radius: 24px;
        padding: 1.25rem 1.5rem;
        margin-bottom: 1.25rem;
        box-shadow: var(--shadow-light), var(--shadow-dark);
        transition: all 0.3s ease;
    }
    
    .student-row:hover {
        transform: translateY(-3px);
        box-shadow: -8px -8px 18px rgba(255,255,255,0.95), 8px 8px 18px rgba(174,174,192,0.5);
    }
    
    .status-btn {
        width: 100px;
        padding: 0.75rem;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: var(--cream);
        box-shadow: inset -2px -2px 5px rgba(255,255,255,0.7), inset 2px 2px 5px rgba(174,174,192,0.2);
    }
    
    .status-btn input[type="radio"] {
        display: none;
    }
    
    .status-btn input[type="radio"]:checked + label {
        font-weight: 800;
    }
    
    .status-btn.present:has(input:checked) {
        background: linear-gradient(135deg, var(--mint), var(--mint-light));
        color: white;
        box-shadow: var(--shadow-light), var(--shadow-dark);
    }
    
    .status-btn.absent:has(input:checked) {
        background: linear-gradient(135deg, var(--peach), #ffd9d4);
        color: white;
        box-shadow: var(--shadow-light), var(--shadow-dark);
    }
    
    .status-btn.late:has(input:checked) {
        background: linear-gradient(135deg, var(--pale-yellow), #fff9d9);
        color: var(--text-dark);
        box-shadow: var(--shadow-light), var(--shadow-dark);
    }
    
    .form-card {
        background: var(--cream);
        border-radius: 32px;
        padding: 2.5rem;
        box-shadow: var(--shadow-light), var(--shadow-dark);
    }
    
    .form-select,
    .form-control {
        padding: 1rem 1.5rem;
        border-radius: 24px;
        border: none;
        background: var(--cream);
        box-shadow: inset -3px -3px 8px rgba(255,255,255,0.8), inset 3px 3px 8px rgba(174,174,192,0.3);
        font-size: 1rem;
        font-family: 'Nunito', sans-serif;
        color: var(--text-dark);
        transition: all 0.3s ease;
    }
    
    .form-select:focus,
    .form-control:focus {
        outline: none;
        box-shadow: inset -4px -4px 10px rgba(255,255,255,0.9), inset 4px 4px 10px rgba(174,174,192,0.4);
    }
    
    .form-label {
        color: var(--text-dark);
        font-weight: 700;
        margin-bottom: 0.75rem;
        font-size: 1.05rem;
    }
    
    .btn-pill {
        padding: 1rem 2rem;
        border-radius: 30px;
        border: none;
        font-weight: 700;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
        box-shadow: var(--shadow-light), var(--shadow-dark);
        font-family: 'Nunito', sans-serif;
    }
    
    .btn-pill-success {
        background: linear-gradient(135deg, var(--mint), var(--mint-light));
        color: white;
    }
    
    .btn-pill-secondary {
        background: var(--cream);
        color: var(--text-dark);
        border: 2px solid var(--lavender-light);
    }
    
    .btn-pill:hover {
        transform: translateY(-3px);
        box-shadow: -8px -8px 18px rgba(255,255,255,0.95), 8px 8px 18px rgba(174,174,192,0.5);
    }
    
    .section-header {
        border-bottom: 2px solid var(--lavender-lighter);
        padding-bottom: 1.25rem;
        margin-bottom: 1.75rem;
    }
    
    .section-header h4 {
        color: var(--text-dark);
        font-weight: 700;
        font-size: 1.5rem;
        margin: 0;
    }
</style>

<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">

<div class="mark-attendance-header">
    <h1><i class="bi bi-check2-square"></i> Mark Attendance</h1>
    <p>Record student attendance for today üìù</p>
</div>

<div class="form-card">
    <form method="POST" id="attendanceForm">
        {% csrf_token %}
        
        <!-- Course and Date Selection -->
        <div class="row g-3 mb-4">
            <div class="col-md-6">
                <label class="form-label"><i class="bi bi-book"></i> Select Course *</label>
                <select name="course" class="form-select form-select-lg" required id="courseSelect">
                    <option value="">Choose a course...</option>
                    {% for course in courses %}
                    <option value="{{ course.id }}">{{ course.course_code }} - {{ course.title }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label"><i class="bi bi-calendar"></i> Date *</label>
                <input type="date" name="date" class="form-control form-control-lg" 
                       value="{{ today }}" required max="{{ today }}">
            </div>
        </div>
        
        <hr style="border-color: var(--lavender-lighter); border-width: 2px; margin: 2rem 0;">
        
        <!-- Students List -->
        <div id="studentsSection">
            <div class="section-header">
                <h4><i class="bi bi-people"></i> Students</h4>
            </div>
            <p class="text-muted" style="text-align: center; padding: 2rem;">Please select a course to see students üëÜ</p>
        </div>
        
        <div class="mt-4 d-flex gap-3 flex-wrap">
            <button type="submit" class="btn-pill btn-pill-success" id="submitBtn">
                <i class="bi bi-check-circle"></i> Save Attendance
            </button>
            <a href="{% url 'attendance_list' %}" class="btn-pill btn-pill-secondary">
                <i class="bi bi-x-circle"></i> Cancel
            </a>
        </div>
    </form>
</div>

<script>
let isSubmitting = false;

document.getElementById('attendanceForm').addEventListener('submit', function(e) {
    if (isSubmitting) {
        e.preventDefault();
        return false;
    }
    
    const courseId = document.querySelector('select[name="course"]').value;
    const date = document.querySelector('input[name="date"]').value;
    
    if (!courseId || !date) {
        e.preventDefault();
        alert('Please select both course and date.');
        return false;
    }
    
    isSubmitting = true;
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Saving...';
});

document.getElementById('courseSelect').addEventListener('change', function() {
    const courseId = this.value;
    if (!courseId) {
        document.getElementById('studentsSection').innerHTML = `
            <div class="section-header">
                <h4><i class="bi bi-people"></i> Students</h4>
            </div>
            <p class="text-muted" style="text-align: center; padding: 2rem;">Please select a course to see students üëÜ</p>
        `;
        return;
    }
    
    fetch(`/api/course/${courseId}/students/`)
        .then(response => response.json())
        .then(data => {
            const students = data.students || [];
            let html = `<div class="section-header"><h4><i class="bi bi-people"></i> Students</h4></div>`;
            
            if (students.length === 0) {
                html += '<p class="text-muted" style="text-align: center; padding: 2rem;">No students enrolled in this course ü§∑</p>';
            } else {
                students.forEach(student => {
                    const studentName = `${student.first_name} ${student.last_name}`;
                    html += `
                        <div class="student-row">
                            <div class="row align-items-center">
                                <div class="col-md-4">
                                    <strong style="color: var(--text-dark); font-size: 1.05rem;">
                                        <i class="bi bi-person-circle" style="color: var(--lavender);"></i> ${studentName}
                                    </strong>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex gap-2">
                                        <div class="status-btn present">
                                            <input type="radio" id="present_${student.id}" 
                                                   name="status_${student.id}" value="present" checked>
                                            <label for="present_${student.id}" class="form-label mb-0 w-100 text-center cursor-pointer">
                                                ‚úì Present
                                            </label>
                                        </div>
                                        <div class="status-btn absent">
                                            <input type="radio" id="absent_${student.id}" 
                                                   name="status_${student.id}" value="absent">
                                            <label for="absent_${student.id}" class="form-label mb-0 w-100 text-center cursor-pointer">
                                                ‚úó Absent
                                            </label>
                                        </div>
                                        <div class="status-btn late">
                                            <input type="radio" id="late_${student.id}" 
                                                   name="status_${student.id}" value="late">
                                            <label for="late_${student.id}" class="form-label mb-0 w-100 text-center cursor-pointer">
                                                ‚è∞ Late
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <input type="text" name="remarks_${student.id}" 
                                           class="form-control form-control-sm" placeholder="Remarks" style="font-size: 0.9rem;">
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            document.getElementById('studentsSection').innerHTML = html;
        })
        .catch(error => {
            console.error('Error fetching students:', error);
            document.getElementById('studentsSection').innerHTML = `
                <div class="alert alert-danger">Error loading students. Please try again.</div>
            `;
        });
});
</script>

{% endblock %}
